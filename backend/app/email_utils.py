# Libraries for email
import smtplib
from email.message import EmailMessage
from datetime import datetime
from pathlib import Path

from app import config #GPIO and SMTP configurations

# Data is pulled config.py
SMTP_HOST     = config.SMTP_HOST
SMTP_PORT     = config.SMTP_PORT
SMTP_USER     = config.SMTP_USER
SMTP_PASSWORD = config.SMTP_PASSWORD
EMAIL_FROM    = config.EMAIL_FROM
EMAIL_TO      = config.EMAIL_TO

# ─── helper to send email ───────────────────────────────────────────
def send_report_email(report_path: Path):
    msg = EmailMessage()
    msg["Subject"] = f"Coconut Report {datetime.now():%Y-%m-%d %H:%M:%S}"
    msg["From"]    = EMAIL_FROM
    msg["To"]      = EMAIL_TO
    msg.set_content("Please find attached the latest coconut count report.")
    with report_path.open("rb") as f:
        data = f.read()
    msg.add_attachment(data, maintype="text", subtype="csv", filename=report_path.name)

    # implicit SSL on 465, STARTTLS on others (e.g. 587)
    if SMTP_PORT == 465:
        smtp = smtplib.SMTP_SSL(SMTP_HOST, SMTP_PORT)
    else:
        smtp = smtplib.SMTP(SMTP_HOST, SMTP_PORT)
        smtp.starttls()

    smtp.login(SMTP_USER, SMTP_PASSWORD)
    smtp.send_message(msg)
    smtp.quit()